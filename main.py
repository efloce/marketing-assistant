import streamlit as st
import os
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

from chains import MarketingTextGenerator

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(
    page_title="–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤",
    page_icon="üìù",
    layout="wide"
)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
@st.cache_resource
def get_generator():
    return MarketingTextGenerator()

generator = get_generator()

# –ó–∞–≥–æ–ª–æ–≤–æ–∫
st.title("üéØ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –∏ –∏–¥–µ–π")
st.markdown("---")

# –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
col1, col2 = st.columns(2)

with col1:
    product = st.text_input("–ü—Ä–æ–¥—É–∫—Ç/–£—Å–ª—É–≥–∞:", "–£–º–Ω—ã–µ —á–∞—Å—ã —Å —Ñ—É–Ω–∫—Ü–∏–µ–π –≠–ö–ì")
    audience = st.text_input("–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è:", "–õ—é–¥–∏ 30-50 –ª–µ—Ç, –∑–∞–±–æ—Ç—è—â–∏–µ—Å—è –æ –∑–¥–æ—Ä–æ–≤—å–µ")

with col2:
    platform = st.selectbox(
        "–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:",
        ["Instagram", "Facebook", "Twitter", "Email —Ä–∞—Å—Å—ã–ª–∫–∞", "–õ–µ–Ω–¥–∏–Ω–≥", "–ë–∞–Ω–Ω–µ—Ä", "YouTube"]
    )
    tone = st.selectbox(
        "–¢–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è:",
        ["–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π", "–î—Ä—É–∂–µ—Å–∫–∏–π", "–í–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π", "–°—Ä–æ—á–Ω—ã–π", "–Æ–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π", "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π"]
    )

# –ö–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
col1, col2, col3 = st.columns(3)

with col1:
    if st.button("üìÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç", use_container_width=True):
        with st.spinner("–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç..."):
            text = generator.generate_text(product, audience, platform, tone)
            st.subheader("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:")
            st.success(text)

with col2:
    if st.button("üí° –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–¥–µ–∏", use_container_width=True):
        with st.spinner("–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–¥–µ–∏..."):
            ideas = generator.generate_idea(product, audience)
            st.subheader("–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ –∏–¥–µ–∏:")
            st.info(ideas)

with col3:
    if st.button("üßπ –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é", use_container_width=True):
        result = generator.clear_memory()
        st.success(result)

# –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
# –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
st.markdown("---")
st.subheader("üìú –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞")

if st.checkbox("–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞"):
    # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ –Ω–∞—à–µ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
    if hasattr(generator, 'history') and generator.history:
        for i, message in enumerate(generator.history):
            if message["type"] == "user":
                st.markdown(f"**üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** {message['content']}")
            elif message["type"] == "ai":
                st.markdown(f"**ü§ñ AI:** {message['content']}")
                st.markdown("---")
            elif message["type"] == "error":
                st.error(f"**‚ùå –û—à–∏–±–∫–∞:** {message['content']}")
                st.markdown("---")
    else:
        st.info("–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –ø—É—Å—Ç–∞")

# –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
st.markdown("---")
st.subheader("üìã –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è")

with st.expander("–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤"):
    st.markdown("""
    ### –ü—Ä–∏–º–µ—Ä 1:
    - **–ü—Ä–æ–¥—É–∫—Ç**: –û–Ω–ª–∞–π–Ω-–∫—É—Ä—Å –ø–æ Python
    - **–ê—É–¥–∏—Ç–æ—Ä–∏—è**: –ù–∞—á–∏–Ω–∞—é—â–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã
    - **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞**: Instagram
    - **–¢–æ–Ω**: –î—Ä—É–∂–µ—Å–∫–∏–π

    ### –ü—Ä–∏–º–µ—Ä 2:
    - **–ü—Ä–æ–¥—É–∫—Ç**: –≠–∫–æ-—Å—É–º–∫–∏
    - **–ê—É–¥–∏—Ç–æ—Ä–∏—è**: –ú–æ–ª–æ–¥–µ–∂—å 18-25 –ª–µ—Ç
    - **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞**: Facebook
    - **–¢–æ–Ω**: –í–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π

    ### –ü—Ä–∏–º–µ—Ä 3:
    - **–ü—Ä–æ–¥—É–∫—Ç**: –î–æ—Å—Ç–∞–≤–∫–∞ –∑–¥–æ—Ä–æ–≤–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è
    - **–ê—É–¥–∏—Ç–æ—Ä–∏—è**: –û—Ñ–∏—Å–Ω—ã–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∏ 25-40 –ª–µ—Ç
    - **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞**: Email —Ä–∞—Å—Å—ã–ª–∫–∞
    - **–¢–æ–Ω**: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π

    ### –ü—Ä–∏–º–µ—Ä 4:
    - **–ü—Ä–æ–¥—É–∫—Ç**: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –º–µ–¥–∏—Ç–∞—Ü–∏–∏
    - **–ê—É–¥–∏—Ç–æ—Ä–∏—è**: –õ—é–¥–∏ —Å –≤—ã—Å–æ–∫–∏–º —É—Ä–æ–≤–Ω–µ–º —Å—Ç—Ä–µ—Å—Å–∞
    - **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞**: YouTube
    - **–¢–æ–Ω**: –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π

    ### –ü—Ä–∏–º–µ—Ä 5:
    - **–ü—Ä–æ–¥—É–∫—Ç**: –ë–µ—Å–ø—Ä–æ–≤–æ–¥–Ω—ã–µ –Ω–∞—É—à–Ω–∏–∫–∏
    - **–ê—É–¥–∏—Ç–æ—Ä–∏—è**: –°—Ç—É–¥–µ–Ω—Ç—ã –∏ –º–æ–ª–æ–¥—ã–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—ã
    - **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞**: Twitter
    - **–¢–æ–Ω**: –Æ–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π
    """)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Ollama
st.markdown("---")
st.subheader("‚öôÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏")

if st.button("üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Ollama", type="secondary"):
    try:
        # –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Ollama
        import requests
        response = requests.get("http://localhost:11434/api/tags")
        if response.status_code == 200:
            models = response.json().get("models", [])
            model_names = [model.get("name", "Unknown") for model in models]
            st.success(f"‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Ollama —É—Å–ø–µ—à–Ω–æ!")
            st.info(f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏: {', '.join(model_names)}")
        else:
            st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {response.status_code}")
    except Exception as e:
        st.error(f"‚ùå –ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Ollama: {str(e)}")
        st.info("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Ollama –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: 'ollama serve'")

# –§—É—Ç–µ—Ä
st.markdown("---")
st.markdown("**–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤** | –°–æ–∑–¥–∞–Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LangChain –∏ Ollama")
st.caption("–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å —á–µ—Ä–µ–∑ Ollama - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç API –∫–ª—é—á–µ–π!")